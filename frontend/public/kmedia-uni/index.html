<!DOCTYPE html>
<html lang="en" style="width: 100%;height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="./kmedia-uni.js"></script>
  <style>
    #app {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body style="margin: 0px;width: 100%;height: 100%;">
  <!-- <div id="handler-container"></div>
  <button onclick="loadVideo(true)">加载实时流</button>
  <button onclick="loadVideo(false)">加载录像回放</button>
  <button onclick="exec('loadVideo')">销毁</button>
  <br><br> -->
  <div id="app"></div>
  <!-- <p>========== 接口测试 ==========</p>
  <span>实时操作</span>
	<button onclick="exec('ptz', 'left')">云台左转</button>
	<button onclick="exec('ptz', 'stop')">关闭云台左转</button>
	<button onclick="exec('startVoiceCall')">开启反向语音</button>
	<button onclick="exec('stopVoiceCall')">关闭反向语音</button>
	<button onclick="exec('startRecord')">开始录制</button>
	<button onclick="exec('stopRecord')">结束录制</button>
  <button onclick="exec('cancelRecord')">取消录制</button>
  <br><br>
  <span>回放操作</span>
	<button onclick="exec('play')">恢复播放</button>
	<button onclick="exec('pause')">暂停</button>
	<button onclick="exec('currentTime', 10)">seek到10s</button>
	<button onclick="exec('frameForward')">帧进</button>
	<button onclick="exec('frameReverse')">帧退</button>
	<button onclick="exec('reversePlay')">倒播</button>
	<button onclick="exec('exitReversePlay')">退出倒播</button>
	<button onclick="exec('changeResolution', 'D1')">切换D1分辨率</button>
	<button onclick="startLoopVideo()">开始轮询</button>
	<button onclick="stopLoopVideo()">停止轮询</button> -->
  <script>
    Date.prototype.format = function(fmt) {
      var o = {
        'M+': this.getMonth() + 1, // 月份
        'd+': this.getDate(), // 日
        'h+': this.getHours(), // 小时
        'm+': this.getMinutes(), // 分
        's+': this.getSeconds(), // 秒
        'q+': Math.floor((this.getMonth() + 3) / 3), // 季度
        'S': this.getMilliseconds() // 毫秒
      }
      if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length))
      }
      for (var k in o) {
        if (new RegExp('(' + k + ')').test(fmt)) {
          fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)))
        }
      }
      return fmt
    }
  </script>
  <script>
    const defaultValue = {
      websocketUrl: 'ws://2.40.54.28',
      devId: '32050800001326000009',
      nmediaId: '',
      startTime: '2021-06-04T00:00:00',
      endTime: '2021-06-05T00:00:00'
    };

    const waterMark = {
      fontSize: 16,
      rotateAngle: -20, 
      fontColor: "rgb(88, 196, 151)",
      opacity: 1,
      textAlign: 'center',
      text: [{
          content: '区联防中心'
        }, {
          content: (new Date()).format('yyyyMMddhhmmss')
        }
      ]
    }

    var url = window.location.search
    var theRequest = new Object();
    // 判断是否有问号
    if (url.indexOf("?") != -1) {
      // 把问号去掉
      var str = url.substr(1);
      // 判断是否有多个参数
      if(str.indexOf("&") != -1) {
        // 以&符分项组成数组
        let strs = str.split("&");
        for (var i = 0; i < strs.length; i++) {
          // 循环数组
          // theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
          // 每一项等号左边为属性，等号右边为属性的值，值需要使用 decodeURI() 函数对通过 escape() 或 url 编码过的字符串进行解码。
          theRequest[strs[i].split("=")[0]] = decodeURI(strs[i].split("=")[1]);
        }
      } else {
        // 只有一个参数
        let arr = str.split("=");
        theRequest[arr[0]] = arr[1];
      }
    };
    defaultValue.devId = theRequest.device_id

    waterMark.fontSize = parseInt(theRequest.fontSize)
    waterMark.fontColor = theRequest.color
    waterMark.opacity = parseInt(theRequest.alpha) / 100
    waterMark.rotateAngle = parseInt(theRequest.rotate)
    waterMark.text[0].content = theRequest.title

    console.log('index.html theRequest: ', theRequest, defaultValue)

    const MODE = KMediaUni.MODE;
    let timer = null;
    let player = new KMediaUni({
      selector: '#app',
			loading: true,
			showMessage: true,
			control: {
				hideControlsBar: false,
				tools: Object.values(KMediaUni.TOOLS)
			}
    });

    console.log('theRequest: ', theRequest, /^true$/i.test(theRequest.visible))

    if (/^true$/i.test(theRequest.visible)) {
      player.watermark(waterMark)
      player.watermarkPreview(true)
    }

    function loadVideo (isLive) {
      player.loadVideo({
        src: {
          ...defaultValue,
          ...(
            isLive
              ? {
                startTime: undefined,
                endTime: undefined
              }
              : {}
          )
        },
        autoplay:true,
        muted: true
      });
    }
    loadVideo(true)

    function startLoopVideo () {
      timer = setInterval(() => {
        loadVideo(true)
      }, 200);
    }

    function stopLoopVideo () {
      timer && clearInterval(timer)
    }

    function exec (cmd, ...args) {
      if (player && player[cmd]) {
        player[cmd](...args);
      } else {
        console.error('not find', cmd);
      }
    }
  </script>
</body>
</html>