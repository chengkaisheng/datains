<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.datains.base.mapper.XpackExtVAuthModelMapper">

    <resultMap id="BaseResultMapDTO" type="io.datains.base.domain.XpackVAuthModelDTO">

        <result column="id" jdbcType="VARCHAR" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="label" jdbcType="VARCHAR" property="label" />
        <result column="pid" jdbcType="VARCHAR" property="pid" />
        <result column="node_type" jdbcType="VARCHAR" property="nodeType" />
        <result column="model_type" jdbcType="VARCHAR" property="modelType" />
        <result column="model_inner_type" jdbcType="VARCHAR" property="modelInnerType" />
        <result column="auth_type" jdbcType="VARCHAR" property="authType" />
        <result column="create_by" jdbcType="VARCHAR" property="createBy" />
        <result column="children_count" property="childrenCount"/>
        <result column="leaf" property="leaf"/>
    </resultMap>

    <select id="searchTree" resultMap="BaseResultMapDTO">
        SELECT
        auth.id, auth.`name`, auth.`label`,
        auth.pid, auth.node_type, auth.model_type,
        auth.model_inner_type, auth.auth_type, auth.create_by,
        authCount.children_count AS children_count,
        IF
        (( authCount.children_count > 0 ), 0, 1 ) AS leaf
        FROM (select get_grant_auths (#{modelType},#{createBy}) c_auth_ids) t1,
        ( SELECT * FROM (select GET_V_AUTH_MODEL_WITH_PARENT(get_grant_auths (#{modelType},#{createBy}),#{modelType}) c_auth_parent_ids) t2,
        <if test="withExtend == 'parent' and id != null">
            (select GET_V_AUTH_MODEL_WITH_PARENT(#{id},#{modelType}) c_model_parent_ids) tmp,
        </if>
        <if test="withExtend == 'children' and id != null">
            (select GET_V_AUTH_MODEL_WITH_CHILDREN(#{id},#{modelType}) c_model_children_ids) tmc,
        </if>
        <if test="name != null and name !='' and withExtend == 'parent'">
            (select GET_V_AUTH_MODEL_WITH_PARENT ( (select GROUP_CONCAT(id) from
            v_auth_model where model_type = #{modelType} and `name` like CONCAT('%', #{name},'%')) ,#{modelType}) c_model_parent_seartch_ids) tmsc,
        </if>
        v_auth_model
        <where>
            model_type = #{modelType}
            <if test="1== withAuth">
                and FIND_IN_SET(v_auth_model.id,c_auth_parent_ids)
            </if>
            <if test="pid !=null">
                and v_auth_model.pid = #{pid}
            </if>

            <if test="withExtend == null and id != null">
                and v_auth_model.id = #{id}
            </if>
            <if test="withExtend == 'parent' and id != null">
                and FIND_IN_SET(v_auth_model.id,c_model_parent_ids)
            </if>
            <if test="withExtend == 'children' and id != null">
                and FIND_IN_SET(v_auth_model.id,c_model_children_ids)
            </if>

            <if test="name != null and name !='' and withExtend == 'parent'">
                and FIND_IN_SET(v_auth_model.id,c_model_parent_seartch_ids)
            </if>

            <if test="name != null and name =='' and withExtend == 'parent'">
                and v_auth_model.pid = '0'
            </if>

        </where>
        ) auth
        LEFT JOIN (
        SELECT
        count( 1 ) AS `children_count`,
        `authTemp`.`pid` AS `pid`
        FROM
        ( SELECT * FROM (select GET_V_AUTH_MODEL_WITH_PARENT(get_grant_auths (#{modelType},#{createBy}),#{modelType}) cids3) t3,v_auth_model
        <where>
            model_type = #{modelType}
            <if test="1== withAuth">
                and FIND_IN_SET(v_auth_model.id,cids3)
            </if>
        </where>
        ) authTemp
        GROUP BY
        authTemp.pid
        ) authCount ON
        auth.id = authCount.pid
        <where>
            <if test="1== withAuth">
                (authCount.children_count>0 or FIND_IN_SET(auth.id,c_auth_ids) )
            </if>
        </where>
        ORDER BY auth.node_type desc, CONVERT(auth.label using gbk) asc

    </select>
</mapper>
